<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>VectraDex</title>
	<link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
	<link rel="stylesheet" href="/static/styles.css?v=1" />
</head>
<body>
	<div class="layout">
		<aside class="sidebar">
			<div class="brand"><img src="/static/logo.svg" alt="VectraDex"/><span>VectraDex</span></div>
			<nav>
				<a href="/" data-match="^/$" class="active">Dashboard</a>
				<a href="/produtos" data-match="^/produtos">Produtos</a>
				<a href="/maquinas" data-match="^/maquinas">Máquinas</a>
				<a href="/dashboard" data-match="^/dashboard">Gráficos</a>
				<a href="/docs" target="_blank">API Docs</a>
			</nav>
		</aside>
		<main class="content">
		<h2>Dashboard</h2>
		<div class="grid-cards" id="kpis" style="display:none;">
			<div class="kpi-card kpi-blue">
				<div class="kpi-title">Produção</div>
				<div class="kpi-value" id="kpi-produced">0</div>
				<div class="kpi-sub">Últimos 7 dias</div>
				<canvas class="spark" id="spark-produced"></canvas>
			</div>
			<div class="kpi-card kpi-green">
				<div class="kpi-title">Tempo Operando</div>
				<div class="kpi-value" id="kpi-operating">0d</div>
				<div class="kpi-sub">Janela de 7 dias</div>
				<canvas class="spark" id="spark-operating"></canvas>
			</div>
			<div class="kpi-card kpi-pink">
				<div class="kpi-title">% Parado</div>
				<div class="kpi-value" id="kpi-stops">0%</div>
				<div class="kpi-sub">Paradas / Operação</div>
				<canvas class="spark" id="spark-stops"></canvas>
			</div>
		</div>

		<div class="grid-2" id="dash-panels" style="margin-top:16px; display:none;">
			<div class="panel">
				<h3>Produção (últimos dias)</h3>
				<canvas id="prod" width="600" height="280"></canvas>
			</div>
			<div class="panel">
				<h3>Motivos de Parada</h3>
				<table class="table" id="reasons"></table>
			</div>
		</div>

		<section id="exports" style="margin-top:18px; display:none;">
			<h2>Exportações</h2>
			<ul>
				<li><a href="/api/export/products/csv">Produtos CSV</a></li>
				<li><a href="/api/export/products/xlsx">Produtos XLSX</a></li>
				<li><a href="/api/export/production/csv">Produção CSV</a></li>
				<li><a href="/api/export/production/xlsx">Produção XLSX</a></li>
			</ul>
		</section>
		</main>
	</div>
	<script>
	function money(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0)}
	function pct(v){return (Math.round((v||0)*1000)/10)+'%'}

	async function load(){
		// Exibir exportações para usuários logados
		try{
			const permRes = await fetch('/api/products/?limit=1', {credentials:'include'});
			if(permRes.status !== 401){ document.getElementById('exports').style.display = ''; }
		}catch(_){}

		// Tentar carregar métricas (apenas admin/gerente têm acesso)
		const mRes = await fetch('/api/dashboard/metrics', {credentials:'include'});
		if(mRes.ok){
			const m = await mRes.json();
			document.getElementById('kpi-produced').textContent = money(m.produced_qty);
			document.getElementById('kpi-operating').textContent = (m.total_operating_time_days||0).toFixed(1)+'d';
			const ratio = (m.total_operating_time_days||0) + (m.total_stopped_time_days||0) > 0
				? (m.total_operating_time_days / ((m.total_operating_time_days)+(m.total_stopped_time_days)))
				: 0;
			document.getElementById('kpi-stops').textContent = pct(1-ratio);
			document.getElementById('kpis').style.display = '';
			document.getElementById('dash-panels').style.display = '';

			const t = await (await fetch('/api/dashboard/timeseries?days=30', {credentials:'include'})).json();
			drawAreaChart(document.getElementById('prod'), t.produced.labels, t.produced.values, ['#22d3ee','#3b82f6']);
			drawSpark(document.getElementById('spark-produced'), t.produced.values, '#22d3ee');
			drawSpark(document.getElementById('spark-operating'), [ratio*100, 100*ratio*0.9, 100*ratio], '#34d399');
			drawSpark(document.getElementById('spark-stops'), t.stops.values, '#ec4899');

			const rtbl = document.getElementById('reasons');
			rtbl.innerHTML = '<thead><tr><th>Motivo</th><th>Qtd</th><th>%</th></tr></thead><tbody></tbody>';
			const totalStops = Object.values(m.stop_reasons||{}).reduce((a,b)=>a+(b||0),0) || 1;
			for(const [reason,count] of Object.entries(m.stop_reasons||{})){
				const tr = document.createElement('tr');
				const pr = Math.round((count/totalStops)*100);
				tr.innerHTML = `<td>${reason}</td><td>${count}</td><td style="min-width:160px"><div class='progress'><span style='width:${pr}%' /></div></td>`;
				rtbl.querySelector('tbody').appendChild(tr);
			}
		}
	}

	function drawSpark(canvas, values, color){
		const ctx = canvas.getContext('2d');
		const w = canvas.width = canvas.clientWidth; const h = canvas.height = canvas.clientHeight;
		ctx.clearRect(0,0,w,h);
		const pad = 6; const W = w - pad*2; const H = h - pad*2; const maxV = Math.max(1, ...values);
		ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
		values.forEach((v,i)=>{ const x = pad + (i/(values.length-1||1))*W; const y = pad + H - (v/maxV)*H; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
		ctx.stroke();
	}

	function drawAreaChart(canvas, labels, values, gradientColors){
		const ctx = canvas.getContext('2d');
		ctx.clearRect(0,0,canvas.width,canvas.height);
		const pad = 40; const W = canvas.width - pad*2; const H = canvas.height - pad*2;
		const maxV = Math.max(10, ...values);
		ctx.strokeStyle = '#1f2a44'; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, pad+H); ctx.lineTo(pad+W, pad+H); ctx.stroke();
		const grad = ctx.createLinearGradient(0, pad, 0, pad+H);
		grad.addColorStop(0, gradientColors[0]+'AA'); grad.addColorStop(1, 'transparent');
		ctx.fillStyle = grad; ctx.strokeStyle = gradientColors[1]; ctx.beginPath();
		values.forEach((v,i)=>{ const x = pad + (i/(values.length-1||1))*W; const y = pad + H - (v/maxV)*H; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
		ctx.lineTo(pad+W, pad+H); ctx.lineTo(pad, pad+H); ctx.closePath(); ctx.fill();
		ctx.beginPath(); values.forEach((v,i)=>{ const x = pad + (i/(values.length-1||1))*W; const y = pad + H - (v/maxV)*H; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.lineWidth = 2; ctx.stroke();
		ctx.fillStyle = '#9aa7bd'; ctx.font = '10px sans-serif'; labels.forEach((lb,i)=>{ const x = pad + (i/(labels.length-1||1))*W; ctx.fillText(String(lb).slice(5), x-10, pad+H+12); });
	}

	// marcar item ativo na sidebar
	(function(){
		const path = location.pathname;
		document.querySelectorAll('.sidebar nav a[data-match]')
			.forEach(a=>{ const rx = new RegExp(a.getAttribute('data-match')); if(rx.test(path)) a.classList.add('active'); else a.classList.remove('active'); });
	})();

	load();
	</script>
</body>
</html>
